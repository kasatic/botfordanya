# 🤖 Telegram Anti-Spam Bot

Бот для модерации чатов друзей. Следит за спамом, банит нарушителей, но с юмором и красивым интерфейсом!

![Python](https://img.shields.io/badge/Python-3.10+-blue)
![Telegram](https://img.shields.io/badge/Telegram-Bot-blue)
![License](https://img.shields.io/badge/License-MIT-green)

## ✨ Возможности

### 🛡️ Антиспам
- **Стикеры и GIF** — лимит на количество за период
- **Фото и видео** — детекция одинаковых файлов
- **Текст** — блокировка повторяющихся сообщений
- **Предупреждения** — "Ещё одно — и в мут!"

### 📊 Прогрессивные баны
```
1-е нарушение → 10 минут
2-е нарушение → 1 час
3-е нарушение → 5 часов
4-е нарушение → 24 часа
5+ нарушений  → 48 часов
```

### 🎨 Красивый UI
- Интерактивное меню с кнопками
- Прогресс-бары нарушений: 🔴🔴⚪⚪⚪
- Рандомные фразы при бане
- Эмодзи для типов спама: 🎭 🎬 🖼 🎥

### ⚙️ Настройки через кнопки
- Изменение лимитов без команд
- Включение/выключение предупреждений
- Настройки для каждого чата отдельно

### 📈 Статистика
- Личная статистика нарушений
- Топ нарушителей чата
- Статистика чата за день/неделю/месяц

### 🎮 Dota 2 интеграция
- Привязка Steam аккаунта
- Проверка «в игре ли» друг
- Статистика последнего матча
- Детальная аналитика с рангами в команде
- Анализ токсичности (wordcloud из чата)
- **Shame-режим** — бот находит самого бесполезного после катки 😈

### 🎯 Бонус
- Напиши «го дота» — бот призовёт всех игроков!

---

## 🚀 Установка

```bash
# Клонировать
git clone <repo-url>
cd telegram-antispam-bot

# Виртуальное окружение
python -m venv venv
venv\Scripts\activate      # Windows
source venv/bin/activate   # Linux/Mac

# Зависимости
pip install -r requirements.txt

# Настройка
cp .env.example .env
# Добавить BOT_TOKEN в .env
```

## ⚙️ Настройка

### 1. Токен бота
Получи токен у [@BotFather](https://t.me/BotFather) и добавь в `.env`:
```env
BOT_TOKEN=your_token_here
```

### 2. Админы (опционально)
Создай `data/admins.txt` — кто может разбанивать:
```
@username1
@username2
```

### 3. Игроки для доты (опционально)
Создай `data/godota.txt`:
```
@player1
@player2
```

## 📋 Команды

### 🛡️ Модерация

| Команда | Описание |
|---------|----------|
| `/menu` | 🏠 Главное меню с кнопками |
| `/stats` | 📊 Твоя статистика |
| `/top` | 🏆 Топ нарушителей |
| `/trust` | 🤍 Добавить в белый список (ответом) |
| `/untrust` | ⛔ Убрать из белого списка |

### 🎮 Dota 2

| Команда | Описание |
|---------|----------|
| `/link <id>` | 🔗 Привязать Steam (Dotabuff/OpenDota/Steam ссылки) |
| `/unlink` | ❌ Отвязать Steam аккаунт |
| `/game` | 🎮 В игре ли ты (или ответом — другой) |
| `/lastgame` | 📊 Краткая инфа о последнем матче |
| `/last` | 📈 Детальная аналитика (GPM/XPM, урон, ранги) |
| `/profile` | 👤 Твой профиль с рангом |
| `/toxic` | ☢️ Анализ токсичности (wordcloud из чата Dota) |
| `/shame on/off` | 😈 Подписка на "позор" после матчей |

## 🎛️ Интерфейс

### Главное меню
```
┌─────────────────────────────────┐
│  📊 Моя статистика  │  🏆 Топ   │
├─────────────────────────────────┤
│  📈 Статистика чата │  ⚙️ Настройки │
├─────────────────────────────────┤
│  🤍 Белый список    │  ❓ Помощь │
└─────────────────────────────────┘
```

### Настройки
```
┌─────────────────────────────────┐
│  🎭 Стикеры/GIF  │  💬 Текст    │
├─────────────────────────────────┤
│  🖼 Картинки     │  🎥 Видео    │
├─────────────────────────────────┤
│       ⚠️ Предупреждения         │
└─────────────────────────────────┘
```

### Изменение лимита
```
┌─────────────────────────────────┐
│     ➖    │   📊 3   │    ➕     │
├─────────────────────────────────┤
│  1️⃣  │  3️⃣  │  5️⃣  │  🔟  │
└─────────────────────────────────┘
```

## 🎮 Dota 2 интеграция

### Привязка Steam

Бот поддерживает несколько форматов для привязки:
- **Friend ID** (9-10 цифр): `123456789`
- **Steam ID 64** (17 цифр): `76561198012345678`
- **Ссылки**: Dotabuff, OpenDota, Steam профиль

```
/link 123456789
/link 76561198012345678
```

### Команда /last — детальная аналитика

Показывает полную статистику последнего матча:
- KDA, GPM, XPM
- Урон героям и вышкам
- Last hits / Denies
- Net Worth
- **Ранги в команде** (🥇🥈🥉) — сравнение с тиммейтами

### Команда /toxic — анализ токсичности

Анализирует wordcloud игрока из чата Dota 2:
- Топ-10 самых частых слов
- Рейтинг токсичности (😇 → ☢️)
- Процент "токсичных" слов

### Shame-режим 😈

Подписка на уведомления после матчей:
```
/shame on   — включить
/shame off  — выключить
```

После каждой катки бот:
1. Находит самого бесполезного игрока среди подписчиков
2. Анализирует KDA, урон, GPM
3. Постит "позор" в чат с упоминанием

_Проверка происходит каждые 2 минуты_

## 🐳 Docker

```bash
# Локальный запуск
docker-compose up -d

# Логи
docker-compose logs -f

# Остановка
docker-compose down
```

## 🚀 Автодеплой на VDS

При пуше в `main` — автоматический деплой через GitHub Actions.

### Быстрая настройка:

1. **На VDS:**
```bash
# Установи Docker
curl -fsSL https://get.docker.com | sh

# Клонируй репо
git clone https://github.com/YOU/REPO.git /opt/antispam-bot
cd /opt/antispam-bot

# Настрой .env
cp .env.example .env && nano .env

# Создай SSH-ключ для GitHub
ssh-keygen -t ed25519 -f ~/.ssh/github_actions
cat ~/.ssh/github_actions.pub >> ~/.ssh/authorized_keys
```

2. **В GitHub → Settings → Secrets:**

| Секрет | Значение |
|--------|----------|
| `VDS_HOST` | IP вашего VDS |
| `VDS_USER` | Пользователь SSH |
| `VDS_PATH` | `/opt/antispam-bot` |
| `VDS_SSH_KEY` | Приватный ключ |

3. **Пуш в main** → автодеплой!

📖 Подробнее: [docs/DEPLOY.md](docs/DEPLOY.md)

## 📁 Структура проекта

```
├── main.py                 # Точка входа
├── src/
│   ├── bot.py              # Главный модуль + graceful shutdown
│   ├── config.py           # Конфигурация
│   ├── database/           # Async SQLite
│   │   ├── connection.py   # Подключение к БД
│   │   └── repositories.py # Репозитории данных
│   ├── services/           # Бизнес-логика
│   │   ├── spam_detector.py
│   │   ├── ban_service.py
│   │   ├── admin_service.py
│   │   ├── dota_service.py
│   │   ├── opendota_service.py # OpenDota API
│   │   └── shame_service.py    # Shame уведомления
│   ├── handlers/           # Telegram handlers
│   │   ├── menu.py         # Навигация и меню
│   │   ├── moderation.py   # Баны и разбаны
│   │   ├── spam.py         # Детекция спама
│   │   └── dota.py         # Dota 2 команды
│   └── ui/                 # UI компоненты
│       ├── keyboards.py    # Inline-клавиатуры
│       └── messages.py     # Шаблоны сообщений
└── data/                   # БД и конфиги
```

## 🔧 Технологии

- **python-telegram-bot** — Telegram Bot API
- **aiosqlite** — асинхронный SQLite
- **aiohttp** — HTTP клиент для OpenDota API
- **python-dotenv** — переменные окружения

## 📜 Лицензия

MIT — делай что хочешь!

---

Made with ❤️ for friends
