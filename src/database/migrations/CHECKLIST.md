# ✅ Чеклист создания миграции

## Перед созданием миграции

- [ ] Определите, какие изменения нужны в схеме БД
- [ ] Проверьте, нет ли уже похожей миграции
- [ ] Убедитесь, что изменения обратимы (можно откатить)
- [ ] Проверьте текущую версию схемы

## Создание файла миграции

- [ ] Создайте файл `migration_XXX_description.py`
  - [ ] XXX - следующий номер версии (002, 003, ...)
  - [ ] description - краткое описание на английском
  - [ ] Используйте snake_case для имени файла

## Написание кода миграции

### Docstring
- [ ] Добавьте docstring с описанием миграции
- [ ] Укажите номер версии
- [ ] Опишите, что делает миграция
- [ ] Перечислите изменения (таблицы, колонки, индексы)

### Функция upgrade()
- [ ] Реализуйте функцию `async def upgrade(conn)`
- [ ] Используйте `IF NOT EXISTS` для CREATE TABLE
- [ ] Используйте `IF NOT EXISTS` для CREATE INDEX
- [ ] Добавьте комментарии к сложным операциям
- [ ] Проверьте SQL синтаксис

### Функция downgrade()
- [ ] Реализуйте функцию `async def downgrade(conn)`
- [ ] Используйте `IF EXISTS` для DROP TABLE
- [ ] Используйте `IF EXISTS` для DROP INDEX
- [ ] Убедитесь, что downgrade полностью отменяет upgrade
- [ ] Учтите порядок удаления (сначала индексы, потом таблицы)

## Регистрация миграции

- [ ] Откройте `src/database/migrations/__init__.py`
- [ ] Добавьте импорт:
  ```python
  from .migration_XXX_description import upgrade as mXXX_upgrade, downgrade as mXXX_downgrade
  ```
- [ ] Добавьте запись в список MIGRATIONS:
  ```python
  (XXX, mXXX_upgrade, mXXX_downgrade, "Description"),
  ```
- [ ] Проверьте, что номер версии уникален
- [ ] Проверьте, что миграции отсортированы по версии

## Тестирование

### Локальное тестирование
- [ ] Создайте резервную копию БД (если есть данные)
- [ ] Запустите приложение
- [ ] Проверьте логи:
  - [ ] "Applying migration XXX"
  - [ ] "Migration XXX applied successfully"
- [ ] Проверьте таблицу schema_version:
  ```sql
  SELECT * FROM schema_version WHERE version = XXX;
  ```
- [ ] Проверьте, что таблицы/колонки созданы
- [ ] Проверьте, что индексы созданы

### Тестирование отката (опционально)
- [ ] Создайте тестовую БД
- [ ] Примените миграцию
- [ ] Вручную вызовите downgrade
- [ ] Проверьте, что все изменения откатились

### Тестирование на чистой БД
- [ ] Удалите БД файл
- [ ] Запустите приложение
- [ ] Проверьте, что все миграции применились
- [ ] Проверьте версию схемы

## Код-ревью

- [ ] Проверьте SQL синтаксис
- [ ] Проверьте использование IF NOT EXISTS / IF EXISTS
- [ ] Проверьте, что downgrade корректен
- [ ] Проверьте комментарии и документацию
- [ ] Проверьте, что миграция атомарна (одно логическое изменение)

## Коммит и деплой

- [ ] Создайте коммит с понятным сообщением:
  ```
  feat: add migration XXX - description
  
  - Creates table_name
  - Adds index on column_name
  ```
- [ ] Создайте Pull Request
- [ ] Дождитесь код-ревью
- [ ] Задеплойте на тестовое окружение
- [ ] Проверьте логи на тестовом окружении
- [ ] Задеплойте на продакшн

## После деплоя

- [ ] Проверьте логи продакшн сервера
- [ ] Убедитесь, что миграция применилась успешно
- [ ] Проверьте версию схемы в продакшн БД
- [ ] Мониторьте ошибки в течение часа

## Если что-то пошло не так

### Миграция не применилась
1. [ ] Проверьте логи на наличие ошибок
2. [ ] Проверьте SQL синтаксис
3. [ ] Проверьте, что миграция зарегистрирована в __init__.py
4. [ ] Проверьте права доступа к файлу БД

### Миграция применилась частично
1. [ ] Проверьте таблицу schema_version
2. [ ] Если версия не записана - миграция откатилась автоматически
3. [ ] Исправьте ошибку в миграции
4. [ ] Перезапустите приложение

### Нужно откатить миграцию
1. [ ] Остановите приложение
2. [ ] Создайте резервную копию БД
3. [ ] Вручную вызовите downgrade:
   ```python
   from src.database.migrations_manager import MigrationManager
   from src.database.migrations.migration_XXX import downgrade
   
   # ... код отката
   ```
4. [ ] Удалите запись из schema_version
5. [ ] Перезапустите приложение

## Лучшие практики

### ✅ DO (Делайте)
- [ ] Используйте IF NOT EXISTS / IF EXISTS
- [ ] Делайте миграции атомарными
- [ ] Добавляйте подробные комментарии
- [ ] Тестируйте на копии продакшн БД
- [ ] Делайте резервные копии перед миграцией
- [ ] Документируйте сложные изменения

### ❌ DON'T (Не делайте)
- [ ] Не изменяйте применённые миграции
- [ ] Не удаляйте данные без бэкапа
- [ ] Не делайте сложные миграции без тестирования
- [ ] Не пропускайте downgrade
- [ ] Не используйте конкатенацию строк в SQL
- [ ] Не делайте несколько логических изменений в одной миграции

## Шаблон для копирования

```python
"""
Миграция XXX: [Описание].

Описание изменений:
- [Изменение 1]
- [Изменение 2]
"""
import aiosqlite


async def upgrade(conn: aiosqlite.Connection) -> None:
    """Применение миграции."""
    # TODO: Реализуйте upgrade
    pass


async def downgrade(conn: aiosqlite.Connection) -> None:
    """Откат миграции."""
    # TODO: Реализуйте downgrade
    pass
```

## Полезные команды

### Проверить версию схемы
```sql
SELECT MAX(version) FROM schema_version;
```

### Посмотреть историю миграций
```sql
SELECT * FROM schema_version ORDER BY version;
```

### Посмотреть все таблицы
```sql
SELECT name FROM sqlite_master WHERE type='table';
```

### Посмотреть структуру таблицы
```sql
PRAGMA table_info(table_name);
```

### Посмотреть все индексы
```sql
SELECT name FROM sqlite_master WHERE type='index';
```

---

**Используйте этот чеклист каждый раз при создании миграции!**

✅ Следование чеклисту гарантирует качество и безопасность миграций.
